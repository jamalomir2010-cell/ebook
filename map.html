<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte - Finder Med</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
    }
    
    #map {
      height: 100vh;
      width: 100%;
    }
    
    .map-controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 15px;
      max-width: 300px;
    }
    
    .map-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: #2c7fb8;
      font-weight: bold;
    }
    
    .doctor-info {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .doctor-name {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    
    .doctor-specialty {
      color: #2c7fb8;
      margin-bottom: 5px;
    }
    
    .doctor-address {
      font-size: 0.9rem;
      color: #666;
    }
    
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .route-btn {
      background-color: #7fcdbb;
      color: #253238;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.3s;
    }
    
    .route-btn:hover {
      background-color: #5bbda5;
    }
    
    .back-btn {
      background-color: #2c7fb8;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background-color 0.3s;
      margin-top: 10px;
    }
    
    .back-btn:hover {
      background-color: #1d5f8a;
    }
    
    .location-btn {
      position: absolute;
      bottom: 30px;
      right: 20px;
      z-index: 1000;
      background: white;
      border: none;
      border-radius: 6px;
      width: 50px;
      height: 50px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #2c7fb8;
    }
    
    @media (max-width: 768px) {
      .map-controls {
        max-width: calc(100% - 40px);
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="map-controls">
    <div class="map-title">
      <i class="fas fa-map"></i>
      <span>Carte Finder Med</span>
    </div>
    
    <div id="selected-doctor-info" class="doctor-info" style="display: none;">
      <div class="doctor-name" id="selected-doctor-name"></div>
      <div class="doctor-specialty" id="selected-doctor-specialty"></div>
      <div class="doctor-address" id="selected-doctor-address"></div>
    </div>
    
    <div class="action-buttons">
      <button class="route-btn" id="route-btn" style="display: none;">
        <i class="fas fa-route"></i> Calculer l'itinéraire
      </button>
      <button class="back-btn" onclick="goBack()">
        <i class="fas fa-arrow-left"></i> Retour à la liste
      </button>
    </div>
  </div>
  
  <button class="location-btn" onclick="locateUser()">
    <i class="fas fa-location-arrow"></i>
  </button>

  <script>
    // Initialisation de la carte centrée sur le Maroc
    const map = L.map('map').setView([33.5731, -7.5898], 13);

    // Chargement du fond de carte OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let routingControl;
    let userMarker;
    let doctorMarkers = [];
    let doctors = [];
    let selectedDoctorId = null;
    let showRoute = false;

    // Initialisation de la carte
    function initMap() {
      // Récupérer les données depuis le localStorage
      const doctorsData = localStorage.getItem('doctors');
      const savedDoctorId = localStorage.getItem('selectedDoctorId');
      const routeSetting = localStorage.getItem('showRoute');
      
      if (doctorsData) {
        doctors = JSON.parse(doctorsData);
      }
      
      if (savedDoctorId) {
        selectedDoctorId = parseInt(savedDoctorId);
      }
      
      if (routeSetting) {
        showRoute = routeSetting === 'true';
      }
      
      // Ajouter les marqueurs des médecins
      addDoctorMarkers();
      
      // Si un médecin est sélectionné, centrer la carte sur lui
      if (selectedDoctorId) {
        const doctor = doctors.find(d => d.id === selectedDoctorId);
        if (doctor) {
          map.setView([doctor.lat, doctor.lon], 15);
          updateSelectedDoctorInfo(doctor);
          
          // Afficher le bouton d'itinéraire
          document.getElementById('route-btn').style.display = 'flex';
          
          // Si showRoute est true, calculer l'itinéraire
          if (showRoute) {
            getRoute(doctor.lat, doctor.lon);
          }
        }
      }
      
      // Localiser l'utilisateur
      locateUser();
      
      // Ajouter l'événement pour le bouton d'itinéraire
      document.getElementById('route-btn').addEventListener('click', function() {
        if (selectedDoctorId) {
          const doctor = doctors.find(d => d.id === selectedDoctorId);
          if (doctor) {
            getRoute(doctor.lat, doctor.lon);
          }
        }
      });
    }

    // Ajouter les marqueurs des médecins sur la carte
    function addDoctorMarkers() {
      doctors.forEach(doc => {
        // Créer une icône personnalisée pour les médecins
        const doctorIcon = L.divIcon({
          className: 'doctor-marker',
          html: `<div style="background-color: #2c7fb8; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><i class="fas fa-user-md"></i></div>`,
          iconSize: [40, 40],
          iconAnchor: [20, 40]
        });
        
        const marker = L.marker([doc.lat, doc.lon], { icon: doctorIcon }).addTo(map);
        
        marker.bindPopup(`
          <div style="min-width: 200px;">
            <b>${doc.name}</b><br>
            <i>${doc.specialty}</i><br>
            ${doc.address}<br>
            <button onclick="selectDoctorOnMap(${doc.id})" 
                    style="background: #2c7fb8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 5px; width: 100%;">
              <i class="fas fa-map-marker-alt"></i> Sélectionner
            </button>
          </div>
        `);
        
        marker.on('click', () => {
          selectDoctorOnMap(doc.id);
        });
        
        doctorMarkers.push(marker);
      });
    }

    // Sélectionner un médecin sur la carte
    function selectDoctorOnMap(doctorId) {
      selectedDoctorId = doctorId;
      const doctor = doctors.find(d => d.id === doctorId);
      
      if (doctor) {
        // Centrer la carte sur le médecin
        map.setView([doctor.lat, doctor.lon], 15);
        
        // Mettre à jour les informations affichées
        updateSelectedDoctorInfo(doctor);
        
        // Afficher le bouton d'itinéraire
        document.getElementById('route-btn').style.display = 'flex';
        
        // Fermer tous les popups
        doctorMarkers.forEach(marker => {
          marker.closePopup();
        });
        
        // Ouvrir le popup du médecin sélectionné
        const marker = doctorMarkers.find(m => {
          const latLng = m.getLatLng();
          return latLng.lat === doctor.lat && latLng.lng === doctor.lon;
        });
        
        if (marker) {
          marker.openPopup();
        }
      }
    }

    // Mettre à jour les informations du médecin sélectionné
    function updateSelectedDoctorInfo(doctor) {
      document.getElementById('selected-doctor-info').style.display = 'block';
      document.getElementById('selected-doctor-name').textContent = doctor.name;
      document.getElementById('selected-doctor-specialty').textContent = doctor.specialty;
      document.getElementById('selected-doctor-address').textContent = doctor.address;
    }

    // Calculer l'itinéraire
    function getRoute(lat, lon) {
      if (routingControl) {
        map.removeControl(routingControl);
      }
      
      navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLon = pos.coords.longitude;
        
        if (userMarker) {
          map.removeLayer(userMarker);
        }
        
        // Créer un marqueur pour la position de l'utilisateur
        const userIcon = L.divIcon({
          className: 'user-marker',
          html: `<div style="background-color: #7fcdbb; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><i class="fas fa-user"></i></div>`,
          iconSize: [30, 30],
          iconAnchor: [15, 30]
        });
        
        userMarker = L.marker([userLat, userLon], { 
          title: "Vous êtes ici",
          icon: userIcon
        }).addTo(map);
        
        // Calculer l'itinéraire
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(userLat, userLon),
            L.latLng(lat, lon)
          ],
          routeWhileDragging: false,
          createMarker: () => null,
          lineOptions: {
            styles: [{color: '#2c7fb8', opacity: 0.7, weight: 5}]
          },
          showAlternatives: false,
          fitSelectedRoutes: true
        }).addTo(map);
        
      }, (error) => {
        let errorMessage = "Impossible d'obtenir votre position.";
        
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = "L'accès à votre position a été refusé. Veuillez autoriser la localisation.";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = "Les informations de localisation ne sont pas disponibles.";
            break;
          case error.TIMEOUT:
            errorMessage = "La demande de localisation a expiré.";
            break;
        }
        
        alert(errorMessage);
      });
    }

    // Localiser l'utilisateur
    function locateUser() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const userLat = position.coords.latitude;
          const userLon = position.coords.longitude;
          
          // Créer un marqueur pour la position de l'utilisateur
          const userIcon = L.divIcon({
            className: 'user-marker',
            html: `<div style="background-color: #7fcdbb; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"><i class="fas fa-user"></i></div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 30]
          });
          
          userMarker = L.marker([userLat, userLon], { 
            title: "Vous êtes ici",
            icon: userIcon
          }).addTo(map);
          
          // Centrer la carte sur la position de l'utilisateur si aucun médecin n'est sélectionné
          if (!selectedDoctorId) {
            map.setView([userLat, userLon], 13);
          }
        }, () => {
          console.log("La localisation a échoué");
        });
      }
    }

    // Retour à la page principale
    function goBack() {
      window.close(); // Tenter de fermer la fenêtre
      // Si la fenêtre ne peut pas être fermée (dépend des paramètres du navigateur), rediriger
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 100);
    }

    // Initialiser la carte au chargement
    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>